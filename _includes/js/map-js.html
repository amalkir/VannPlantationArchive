{% if site.data.theme.map-child-objects == true %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
{% else %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid and item.parentid == nil' -%}
{% endif %}
{%- assign items = items | where_exp: 'item','item.latitude != nil and item.longitude != nil' -%}
{%- assign fields = site.data.config-map -%}
{%- assign geo_items = site.data[site.metadata] | where_exp: 'item','item.georeferenced != nil and item.objectid != nil' -%}
<!-- load leaflet dependencies -->
<script src="{{ '/assets/lib/leaflet/leaflet.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/Leaflet.fullscreen.min.js' | relative_url }}"></script>
{% if site.data.theme.map-search == true %}<script src="{{ '/assets/lib/leaflet/fuse.min.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/leaflet.fusesearch.js' | relative_url }}"></script>{% endif %}
{% if site.data.theme.map-cluster == true %}<script src="{{ '/assets/lib/leaflet/leaflet.markercluster.js' | relative_url }}"></script>{% endif %}
{% if site.data.theme.map-search == true and site.data.theme.map-cluster == true %}<script src="{{ '/assets/lib/leaflet/leaflet.markercluster.freezable.js' | relative_url }}"></script>{% endif %}


<script>
    console.log("Total items in metadata:", {{ site.data[site.metadata] | size }});
    console.log("Items after objectid filter:", {{ items | size }});

    // {% for item in site.data[site.metadata] %}
    //     {% if item.objectid == nil or item.objectid == "" or item.objectid == empty %}
    //         console.log("Excluding item without objectid:", {{ item | jsonify }});
    //     {% endif %}
    //     {% if item.latitude == nil or item.longitude == nil %}
    //         console.log("Excluding item without geolocation:", {{ item | jsonify }});
    //     {% endif %}
    // {% endfor %}
    /* load items as map as georeferenced documents

        Structure:
        items = {
                id: int,
                title: string
                thumbnail: path,
                date: int{4},
                source: string,
                bounds: [[float, float], [float, float]],
                item_page_url: path,
                opacity: float,
            }
    */

   /* Initialize documents array and populate */
    let documents = []
    console.log("Loading documents for map...")
    {% for item in items %}
        // console.log("Raw item data:", "{{item | jsonify}}");
        documents.push({   
            id: "{{item.objectid}}",
            title: "{{item.title}}",
            thumbnail: {{item.image_thumb | relative_url | jsonify}},
            subject: {{item.subject | jsonify}},
            creator: {{item.creator | jsonify}},
            date: {{item.date}},
            source: "{{item.source}}",
            bounds: [{{item.bounds_nw | split:',' | jsonify}}, {{item.bounds_se | split: ',' |jsonify}}],
            item_page_url: "{{ '/items/' | relative_url }}{% if item.parentid %}{{ item.parentid }}.html#{{ item.objectid }}{% else %}{{ item.objectid }}.html{% endif %}",
            opacity: 0.7
        });
    {% endfor %}

    // console.log(documents)

    /* List of Active Overlay Layers */
    let activeOverlays = {}

    /* Create layer group for document overlays */
    let documentLayerGroup = L.layerGroup();
    
    /* Default map center on North Carolina */
    const map = L.map('map').setView([35.7596, -79.0193], 7)

    /* add map layer options */
    const Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
    });
    const Esri_NatGeoWorldMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC',
        maxZoom: 16
    });
    const Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
    const OpenStreetMap_Mapnik = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    /* add base map switcher */
    const baseMaps = {
        "Esri World StreetMap": Esri_WorldStreetMap,
        "Esri National Geo": Esri_NatGeoWorldMap,
        "Esri Imagery": Esri_WorldImagery,
        "Open Street Map": OpenStreetMap_Mapnik
    };
    L.control.layers(baseMaps).addTo(map);
    /* load base map */
    {{ site.data.theme.map-base | default: 'Esri_WorldStreetMap' }}.addTo(map);

    /* add document layer gorup to map */
    documentLayerGroup.addTo(map);

    /* add fullscreen control */ 
    map.addControl(new L.Control.Fullscreen());

    /* Add document cards to div */
    function createDocumentCards() {
        const documentList = document.getElementById('document-list');
        
        documents.forEach(doc => {
            const card = document.createElement('div');
            card.className = 'document-card';
            card.dataset.docId = doc.id;
            
            const thumbnail = document.createElement('img');
            thumbnail.className = 'document-thumbnail';
            thumbnail.src = doc.thumbnail;
            thumbnail.alt = doc.title;
            
            const info = document.createElement('div');
            info.className = 'document-info';
            
            const title = document.createElement('div');
            title.className = 'document-title';
            title.textContent = doc.title;
            
            const metadata = document.createElement('div');
            metadata.className = 'document-metadata';
            metadata.textContent = `${doc.date} - ${doc.source}`;
            
            info.appendChild(title);
            info.appendChild(metadata);
            
            card.appendChild(thumbnail);
            card.appendChild(info);
            
            // Add click event to toggle the document on the map
            card.addEventListener('click', () => toggleDocumentOnMap(doc));
            
            documentList.appendChild(card);
        });
    }
    
    /* Function to remove document overlay from map */
    function unsetDocOverlay(docId) {
            documentLayerGroup.removeLayer(activeOverlays[docId]);
            delete activeOverlays[docId];
            const card = document.querySelector(`.document-card[data-doc-id="${docId}"]`);
            if (card) {
                card.classList.remove('active');
            }
            updateActiveLayersList();
        }
    
    /* Function to toggle documents on map */
    function toggleDocumentOnMap(doc) {
            const card = document.querySelector(`.document-card[data-doc-id="${doc.id}"]`);

            if (activeOverlays[doc.id]) {
                // center maps on document and open popup if already active
                const bounds = L.latLngBounds(doc.bounds);
                map.fitBounds(bounds);
            } else {
                // Add the overlay if it's not active
                const bounds = L.latLngBounds(doc.bounds);
                
                // Create an image overlay using the document's bounds
                const overlay = new L.ImageOverlay(
                    doc.thumbnail,
                    bounds,
                    {
                        opacity: doc.opacity,
                        interactive: true,
                        alt: doc.title
                    }
                );
                
                // Add the overlay to the map
                // overlay.addTo(map);

                // Add overlay to document layer group
                documentLayerGroup.addLayer(overlay);

                // Store the overlay for later management
                activeOverlays[doc.id] = overlay;

                console.log("Active overlays:", Object.keys(activeOverlays));

                // Highlight the card
                card.classList.add('active');
                
                // Fit the map to the document bounds
                map.fitBounds(bounds);

                // remove overlay layer and add it again
                map.removeLayer(documentLayerGroup);
                documentLayerGroup.addTo(map);
                
                // Update the active layers list
                updateActiveLayersList();
                
                // Add a popup when clicking on the overlay
                overlay.on('click', (e) => {
                    L.popup()
                        .setLatLng(bounds.getCenter())
                        .setContent(`<strong>${doc.title}</strong>
                                    <br>
                                    <strong>Date:</strong> ${doc.date}<br>
                                    <strong>Creator:</strong> ${doc.creator}<br>
                                    <strong>Subject:</strong> ${doc.subject}<br>
                                    <br>${doc.date} - ${doc.source}<br>
                                    <a href="${window.location.origin}/items/${doc.id}.html" target="_blank">View Item</a>`)
                        .openOn(map);
                });
            }
        }
    
    /* Function to update Active Layers List */
    function updateActiveLayersList() {
            const activeLayersContainer = document.getElementById('active-layers');
            activeLayersContainer.innerHTML = '';
            
            const activeDocIds = Object.keys(activeOverlays);
            
            if (activeDocIds.length === 0) {
                activeLayersContainer.textContent = 'No active layers';
                return;
            }
            
            activeDocIds.forEach(docId => {
                const doc = documents.find(d => d.id === docId);
                if (doc) {
                    const layerItem = document.createElement('div');
                    layerItem.className = 'active-doc-div';
                    
                    // Create layer name with remove button
                    layerItem.innerHTML = `
                        <div style="position: relative; width: 120px; height: 60px; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            <img src="${doc.thumbnail}" alt="${doc.title}" 
                                 style="width: 100%; height: 100%; object-fit: cover; display: block;">
                            
                            <!-- Remove button (X) in top-right corner -->
                            <button style="
                                position: absolute;
                                top: 2px;
                                right: 2px;
                                width: 16px;
                                height: 16px;
                                border: none;
                                background: rgba(244, 67, 54, 0.9);
                                color: white;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 10px;
                                line-height: 1;
                                padding: 0;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                            " title="Remove layer">Ã—</button>
                            
                            <!-- Title overlay at bottom -->
                            <div style="
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                background: linear-gradient(transparent, rgba(0,0,0,0.7));
                                color: white;
                                padding: 8px 4px 4px;
                                font-size: 10px;
                                font-weight: bold;
                                text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            ">${doc.title}</div>
                        </div>
                        
                        <!-- Opacity slider below thumbnail -->
                        <div style="width: 120px; margin-top: 3px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 9px; color: #666; margin-bottom: 2px;">
                                <span>Opacity</span>
                                <span id="opacity-value-${docId}">${Math.round(doc.opacity * 100)}%</span>
                            </div>
                            <input type="range" id="opacity-${docId}" min="0" max="1" step="0.1" value="${doc.opacity}" 
                                   style="width: 100%; height: 4px;">
                        </div>
                    `;
                    
                    // Add event listener to remove button
                    const removeButton = layerItem.querySelector('button');
                    removeButton.addEventListener('click', () => {
                        // Remove the overlay
                        documentLayerGroup.removeLayer(activeOverlays[docId]);
                        delete activeOverlays[docId];
                        
                        // Remove active class from card
                        const card = document.querySelector(`.document-card[data-doc-id="${docId}"]`);
                        card.classList.remove('active');
                        
                        // Update the active layers list
                        updateActiveLayersList();
                    });
                    
                    // Add event listener to opacity slider
                    const opacitySlider = layerItem.querySelector(`#opacity-${docId}`);
                    const opacityValue = layerItem.querySelector(`#opacity-value-${docId}`);
                    opacitySlider.addEventListener('input', (e) => {
                        const opacity = parseFloat(e.target.value);
                        activeOverlays[docId].setOpacity(opacity);
                        opacityValue.textContent = `${Math.round(opacity * 100)}%`;
                    });
                    activeLayersContainer.appendChild(layerItem);
                }
            });
        }
      
    /* Initialize the document cards */
    createDocumentCards();
    
    /* Update active layers list */
    updateActiveLayersList();

</script>